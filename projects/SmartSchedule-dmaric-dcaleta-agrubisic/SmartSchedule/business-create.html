<!-- business-create.html - Kreiranje poslovnog rasporeda -->
<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartSchedule - Kreiraj raspored</title>
  <link rel="stylesheet" href="css/global.css">
</head>
<body>
  <div id="profileCorner" style="position:absolute;top:18px;right:24px;background:#20243a;padding:8px 16px;border-radius:8px;color:#3a7afe;font-weight:bold;font-size:1.1em;z-index:10;display:flex;align-items:center;gap:16px;"></div>
  <div class="container business-create-container" style="display:flex;gap:32px;align-items:flex-start;">
    <div style="flex:2;">
      <h2>Kreiraj poslovni raspored</h2>
      <form id="businessForm">
        <!-- Polja za unos podataka tvrtke su premještena u modal -->
        <input type="text" id="scheduleName" placeholder="Naziv rasporeda" required autocomplete="off" style="margin-bottom:12px;width:100%;">
      </form>
      <div id="businessWorkers"></div>
      <button id="toFinalBtn" disabled style="opacity:0.5;">Nastavi na raspored</button>
    </div>
    <div id="companyInfoTab" style="flex:1;min-width:220px;background:#20243a;padding:18px 14px;border-radius:10px;box-shadow:0 2px 12px #0005;">
      <h3 style="margin-top:0;">Podaci tvrtke</h3>
      <div id="companyInfoContent">Nema spremljenih podataka.</div>
      <button id="openCompanyModal" style="margin-top:12px;">Uredi podatke tvrtke</button>
    </div>
  </div>
  <script src="js/auth.js"></script>
  <script src="js/navigation.js"></script>
  <script src="js/schedules.js"></script>
</script>
<script>
// Prikaz profila u kutu
document.addEventListener('DOMContentLoaded', function() {
  const session = sessionStorage.getItem('sessionUser');
  if (session) {
    const user = JSON.parse(session);
    const profileDiv = document.getElementById('profileCorner');
    if (profileDiv) {
      profileDiv.innerHTML = `${user.username}#${user.id || ''} <button id='cornerLogoutBtn' style='margin-left:12px;background:#3a7afe;color:#fff;border:none;padding:4px 12px;border-radius:6px;cursor:pointer;'>Odjava</button>`;
      document.getElementById('cornerLogoutBtn').onclick = function() { sessionStorage.removeItem('sessionUser'); window.location.href = 'index.html'; };
    }
  }
});
document.addEventListener('DOMContentLoaded', function() {
    // Modal za podatke tvrtke
    let companyModal = document.createElement('div');
    companyModal.id = 'companyModal';
    companyModal.style.display = 'none';
    companyModal.style.position = 'fixed';
    companyModal.style.top = '0';
    companyModal.style.left = '0';
    companyModal.style.width = '100vw';
    companyModal.style.height = '100vh';
    companyModal.style.background = 'rgba(0,0,0,0.7)';
    companyModal.style.justifyContent = 'center';
    companyModal.style.alignItems = 'center';
    companyModal.innerHTML = '<div style="background:#181c24;padding:36px 28px;border-radius:16px;max-width:440px;margin:100px auto;display:flex;flex-direction:column;gap:18px;box-shadow:0 6px 32px #000b;border:2px solid #232837;">'
      + '<h3>Podaci tvrtke</h3>'
      + '<form id="companyFormModal">'
      + '<input type="text" id="modalCompanyName" placeholder="Naziv tvrtke" required autocomplete="off">'
      + '<input type="text" id="modalCompanyOIB" placeholder="OIB tvrtke" autocomplete="off">'
      + '<label>Radni dani:</label>'
      + '<select id="modalWorkDays"><option value="6">Ponedjeljak - Subota</option><option value="7">Ponedjeljak - Nedjelja</option></select>'
      + '<label>Radno vrijeme:</label>'
      + '<input type="text" id="modalWorkHours" placeholder="07:00-21:00" required autocomplete="off">'
      + '<label>Tjedni limit sati po radniku:</label>'
      + '<input type="number" id="modalWeeklyLimit" value="48" min="1" max="60" required autocomplete="off">'
      + '<button type="submit">Spremi podatke</button>'
      + '<button type="button" id="closeCompanyModal" style="background:#444;margin-top:8px;">Odustani</button>'
      + '</form></div>';
    document.body.appendChild(companyModal);

    document.getElementById('openCompanyModal').onclick = function() {
      // Popuni modal s postojećim podacima
      const companyData = JSON.parse(localStorage.getItem('companyData') || '{}');
      const session = JSON.parse(sessionStorage.getItem('sessionUser') || '{}');
      document.getElementById('modalCompanyName').value = companyData.companyName || session.companyName || '';
      document.getElementById('modalCompanyOIB').value = companyData.companyOIB || session.companyOIB || '';
      document.getElementById('modalWorkDays').value = companyData.workDays || '6';
      document.getElementById('modalWorkHours').value = companyData.workHours || '';
      document.getElementById('modalWeeklyLimit').value = companyData.weeklyLimit || '48';
      companyModal.style.display = 'flex';
    };
    document.getElementById('closeCompanyModal').onclick = function() {
      companyModal.style.display = 'none';
    };
    document.getElementById('companyFormModal').onsubmit = function(e) {
      e.preventDefault();
      const companyData = {
        companyName: document.getElementById('modalCompanyName').value.trim(),
        companyOIB: document.getElementById('modalCompanyOIB').value.trim(),
        workDays: parseInt(document.getElementById('modalWorkDays').value),
        workHours: document.getElementById('modalWorkHours').value.trim(),
        weeklyLimit: parseInt(document.getElementById('modalWeeklyLimit').value)
      };
      localStorage.setItem('companyData', JSON.stringify(companyData));
      prikaziTabTvrtke();
      alert('Podaci tvrtke spremljeni!');
      companyModal.style.display = 'none';
    };
  const businessForm = document.getElementById('businessForm');
  const workersDiv = document.getElementById('businessWorkers');
  const toFinalBtn = document.getElementById('toFinalBtn');
  let workers = JSON.parse(localStorage.getItem('workers') || '[]');
  function renderWorkers() {
    // Dodaj šefa u listu radnika ako je boss prijavljen
    const session = JSON.parse(sessionStorage.getItem('sessionUser') || '{}');
    let allWorkers = [...workers];
    if (session.role === 'boss' && !allWorkers.find(w => w.username === session.username && w.id === session.id)) {
      allWorkers.push({ username: session.username, id: session.id });
    }
    let html = '<h3>Radnici (uključuje šefa)</h3>';
    html += '<form id="addWorkerForm" style="display:flex;gap:8px;align-items:center;"><input type="text" id="workerName" placeholder="Ime radnika" required> <input type="text" id="workerId" placeholder="ID radnika" required style="width:120px;"> <button type="submit">Dodaj</button></form>';
    if (allWorkers.length === 0) {
      html += '<p style="color:#e74c3c;margin-top:12px;">Dodajte barem jednog radnika za nastavak!</p>';
      toFinalBtn.disabled = true;
      toFinalBtn.style.opacity = '0.5';
    } else {
      toFinalBtn.disabled = false;
      toFinalBtn.style.opacity = '1';
    }
    html += '<ul>' + allWorkers.map(w => `<li>${w.username}#${w.id || ''}${session.role === 'boss' && w.username === session.username ? ' <span style="color:#3a7afe;">(šef)</span>' : ''}</li>`).join('') + '</ul>';
    workersDiv.innerHTML = html;
    document.getElementById('addWorkerForm').onsubmit = function(e) {
      e.preventDefault();
      const name = document.getElementById('workerName').value.trim();
      const id = document.getElementById('workerId').value.trim();
      if (!name || !id) return;
      if (workers.find(w => w.username === name || w.id === id)) return;
      workers.push({ username: name, id });
      localStorage.setItem('workers', JSON.stringify(workers));
      renderWorkers();
    };
  }
  renderWorkers();
  function prikaziTabTvrtke() {
    const companyData = JSON.parse(localStorage.getItem('companyData') || '{}');
    const session = JSON.parse(sessionStorage.getItem('sessionUser') || '{}');
    const el = document.getElementById('companyInfoContent');
    
    // Ako nema companyData u localStorage, ali korisnik je registriran kao poslodavac s OIB-om
    if ((!companyData || !companyData.companyName) && session.companyName && session.companyOIB) {
      el.innerHTML =
        '<b>Naziv:</b> ' + session.companyName + '<br>' +
        '<b>OIB:</b> ' + session.companyOIB + '<br>' +
        '<i style="color:#999;">Upute: Možete urediti podatke tvrtke u formi ispod.</i>';
      return;
    }
    
    if (!companyData || !companyData.companyName) {
      el.innerHTML = 'Nema spremljenih podataka.';
      return;
    }
    el.innerHTML =
      '<b>Naziv:</b> ' + companyData.companyName + '<br>' +
      (companyData.companyOIB ? '<b>OIB:</b> ' + companyData.companyOIB + '<br>' : '') +
      '<b>Radni dani:</b> ' + (companyData.workDays == 7 ? 'Ponedjeljak-Nedjelja' : 'Ponedjeljak-Subota') + '<br>' +
      '<b>Radno vrijeme:</b> ' + companyData.workHours + '<br>' +
      '<b>Tjedni limit:</b> ' + companyData.weeklyLimit + ' sati';
  }
  prikaziTabTvrtke();
  businessForm.onsubmit = function(e) {
    e.preventDefault();
    const companyData = {
      companyName: document.getElementById('companyName').value.trim(),
      workDays: parseInt(document.getElementById('workDays').value),
      workHours: document.getElementById('workHours').value.trim(),
      weeklyLimit: parseInt(document.getElementById('weeklyLimit').value)
    };
    localStorage.setItem('companyData', JSON.stringify(companyData));
    toFinalBtn.style.display = 'block';
    prikaziTabTvrtke();
    alert('Podaci tvrtke spremljeni! Dodajte radnike i nastavite.');
  };
  toFinalBtn.onclick = function() {
    // Provjeri ima li radnika
    let workers = JSON.parse(localStorage.getItem('workers') || '[]');
    if (!workers.length) {
      alert('Dodajte barem jednog radnika prije nastavka!');
      return;
    }
    // Generiraj novu šifru za novi raspored
    let code = (window.randomId ? window.randomId() : Math.random().toString(36).substr(2,8).toUpperCase());
    localStorage.setItem('scheduleCode', code);
    // Očisti stare podatke za novi raspored
    localStorage.removeItem('schedule');
    // Pripremi praznu strukturu za novi raspored
    let allSchedules = JSON.parse(localStorage.getItem('allSchedules') || '{}');
    // Spremi naziv rasporeda, radnike i podatke o tvrtki uz kod
    const scheduleName = document.getElementById('scheduleName').value.trim();
    let businessData = JSON.parse(localStorage.getItem('companyData') || '{}');
    // Parsiraj radno vrijeme (npr. '07:00-21:00') u startHour i endHour
    if (businessData.workHours) {
      const match = businessData.workHours.match(/(\d{1,2}):\d{2}\s*-\s*(\d{1,2}):\d{2}/);
      if (match) {
        businessData.startHour = parseInt(match[1], 10);
        businessData.endHour = parseInt(match[2], 10);
      }
    }
    allSchedules[code] = { name: scheduleName, workers: workers, business: businessData };
    localStorage.setItem('allSchedules', JSON.stringify(allSchedules));
    // Očisti radnike za fresh start
    localStorage.removeItem('workers');
    // Spremljeni podaci tvrtke se koriste za raspored
    localStorage.setItem('business', JSON.stringify(businessData));
    window.location.href = 'business-final.html';
  };
});
</script>
</body>
</html>
